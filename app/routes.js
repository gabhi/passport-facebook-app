module.exports = function(app, passport) {

  // normal routes ===============================================================

  // show the home page (will also have our login links)
  // app.get('/', function(req, res) {
  //     res.render('index.ejs');
  // });

  app.get('/', function(req, res) {
    res.render('test.ejs');
  });

  // PROFILE SECTION =========================
  app.get('/profile', isLoggedIn, function(req, res) {
    console.log(req.user.facebook._json.birthday);

    function getZodiacSign(day, month) {

      var zodiacSigns = {
        'capricorn': {
          "name": "capricorn",
          "trait": "Responsible, patient, ambitious, resourceful, loyal"
        },
        'aquarius': {
          "name": "aquarius",
          "trait": "Witty, Clever, Humanitarian, Inventive, Original"
        },
        'pisces': {
          "name": "pisces",
          "trait": "Compassionate, Adaptable, Accepting, Devoted, Imaginative"
        },
        'aries': {
          "name": "aries",
          "trait": "Independent, Generous, Optimistic, Enthusiastic, Courageous"
        },
        'taurus': {
          "name": "taurus",
          "trait": "Dependable, Persistent, Loyal, Patient, Generous"
        },
        'gemini': {
          "name": "gemini",
          "trait": "Energetic, Clever, Imaginative, Witty, Adaptable"
        },
        'cancer': {
          "name": "cancer",
          "trait": "Loyalty, Dependable, Caring, Adaptable, Responsive"
        },
        'leo': {
          "name": "leo",
          "trait": "Confident, Ambitious, Generous, Loyal, Encouraging"
        },
        'virgo': {
          "name": "virgo",
          "trait": "Analytical, Observant, Helpful, Reliable, Precise"
        },
        'libra': {
          "name": "libra",
          "trait": "Diplomatic, Graceful, Peaceful, Idealistic, Hospitable"
        },
        'scorpio': {
          "name": "scorpio",
          "trait": "Loyal, Passionate, Resourceful, Observant, Dynamic"
        },
        'sagittarius': {
          "name": "sagittarius",
          "trait": "Independent, Optimistic, Cheerful, Honest, Intellectual"
        }
      }

      if ((month == 1 && day <= 20) || (month == 12 && day >= 22)) {
        return zodiacSigns.capricorn;
      } else if ((month == 1 && day >= 21) || (month == 2 && day <= 18)) {
        return zodiacSigns.aquarius;
      } else if ((month == 2 && day >= 19) || (month == 3 && day <= 20)) {
        return zodiacSigns.pisces;
      } else if ((month == 3 && day >= 21) || (month == 4 && day <= 20)) {
        return zodiacSigns.aries;
      } else if ((month == 4 && day >= 21) || (month == 5 && day <= 20)) {
        return zodiacSigns.taurus;
      } else if ((month == 5 && day >= 21) || (month == 6 && day <= 20)) {
        return zodiacSigns.gemini;
      } else if ((month == 6 && day >= 22) || (month == 7 && day <= 22)) {
        return zodiacSigns.cancer;
      } else if ((month == 7 && day >= 23) || (month == 8 && day <= 23)) {
        return zodiacSigns.leo;
      } else if ((month == 8 && day >= 24) || (month == 9 && day <= 23)) {
        return zodiacSigns.virgo;
      } else if ((month == 9 && day >= 24) || (month == 10 && day <= 23)) {
        return zodiacSigns.libra;
      } else if ((month == 10 && day >= 24) || (month == 11 && day <= 22)) {
        return zodiacSigns.scorpio;
      } else if ((month == 11 && day >= 23) || (month == 12 && day <= 21)) {
        return zodiacSigns.sagittarius;
      }
    }


    var _json = JSON.parse(req.user.facebook._json);
    var zodiacPart = "";


    if (req.user.facebook.birthday) {
      var birthday = req.user.facebook.birthday;
      var arr = birthday.split("/");
      zodiacPart = getZodiacSign(arr[1], arr[0]);

    }


    var bluemix = require('bluemix'),
      watson = require('watson-developer-cloud');


    var watson = require('watson-developer-cloud');

    var personality_insights = watson.personality_insights({
      username: '55238a5d-1554-46bb-85ba-34ec2ec2261d',
      password: 'vo6LiKnQRMOW',
      version: 'v2'
    });

    personality_insights.profile({
        text: "Bernard Marr is a best-selling business author, confidence happy sad sure  keynote speaker and consultant in strategic performance, analytics, KPIs and big data. He is one of the world's most highly respected voices anywhere when it comes to data in business. His leading-edge work with major companies, organisations and governments across the globe makes him a globally acclaimed and award-winning researcher, consultant and teacher. Bernard is acknowledged by the CEO Journal as one of today 's leading business brains and by LinkedIn as one of the World's top 100 business Influencers.He has written a number of seminal books and over 200 high profile reports"
      },
      function(err, response) {
        if (err)
          console.log('error:', err);
        else
          console.log(JSON.stringify(response, null, 2));
      });



    var books = (_json.books) ? "books, " : null;
    var television = _json.television ? "television, " : null;
    var music = _json.music ? "music, " : null;
    var favorite_athletes = _json.favorite_athletes ? "sports" : null;
    var favorite_teams = _json.favorite_teams ? "teams" : null;

    var sports = null;
    if (favorite_athletes || favorite_teams) sports = "sports";

    var list = {};
    var getSortedKeys = function(obj) {
      var keys = [];
      for (var key in obj) keys.push(key);
      return keys.sort(function(a, b) {
        return obj[a] - obj[b]
      });
    }

    var SortArrayByKeys = function(inputarray) {
      var arraykeys = [];
      for (var k in inputarray) {
        arraykeys.push(k);
      }
      arraykeys.sort();

      var outputarray = [];
      for (var i = 0; i < arraykeys.length; i++) {
        outputarray[arraykeys[i]] = inputarray[arraykeys[i]];
      }
      return outputarray;
    }
    var order = [];

    var cmp = function(a, b) {
      if (list[a] < list[b]) return -1;
      if (list[a] > list[b]) return 1;
      return 0;
    }

    _json.posts.data.forEach(function(element, index, array) {

      if (element.name) {
        var str = element.name;
        var res = str.split(" ");
        console.log(res);

        res.forEach(function(ele, index, arr) {
          if (list[ele]) {
            list[ele] = list[ele] + 1;
          } else list[ele] = 1;
        });

      }



    });
    console.log((list));
    for (i in list) order.push(i);
    order.sort(cmp);
    console.log(order);
    //console.log(SortArrayByKeys(list));

    var msg = "You are into " + books + television + music + sports;
    //<strong>You seem to be </strong>:
    //if(req.user.facebook._json.books) msg += "books, ";
    //  console.log(JSON.stringify(_json.posts.data, null, 2))
    res.render('profile.ejs', {
      user: req.user,
      _json: _json,
      zodiacPart: zodiacPart,
      msg: msg
    });
  });

  // LOGOUT ==============================
  app.get('/logout', function(req, res) {
    req.logout();
    res.redirect('/');
  });

  // =============================================================================
  // AUTHENTICATE (FIRST LOGIN) ==================================================
  // =============================================================================

  // locally --------------------------------
  // LOGIN ===============================
  // show the login form
  app.get('/login', function(req, res) {
    res.render('login.ejs', {
      message: req.flash('loginMessage')
    });
  });

  // process the login form
  app.post('/login', passport.authenticate('local-login', {
    successRedirect: '/profile', // redirect to the secure profile section
    failureRedirect: '/login', // redirect back to the signup page if there is an error
    failureFlash: true // allow flash messages
  }));

  // SIGNUP =================================
  // show the signup form
  app.get('/signup', function(req, res) {
    res.render('signup.ejs', {
      message: req.flash('signupMessage')
    });
  });

  // process the signup form
  app.post('/signup', passport.authenticate('local-signup', {
    successRedirect: '/profile', // redirect to the secure profile section
    failureRedirect: '/signup', // redirect back to the signup page if there is an error
    failureFlash: true // allow flash messages
  }));

  // facebook -------------------------------

  // send to facebook to do the authentication
  app.get('/auth/facebook', passport.authenticate('facebook', {
    scope: ['public_profile', 'email', 'user_likes', 'user_status',
      'user_birthday', 'user_actions.books', 'user_actions.music',
      'user_friends', 'user_education_history'
    ]
  }));

  // handle the callback after facebook has authenticated the user
  app.get('/auth/facebook/callback',
    passport.authenticate('facebook', {
      successRedirect: '/profile',
      failureRedirect: '/'
    }));

  // twitter --------------------------------

  // send to twitter to do the authentication
  app.get('/auth/twitter', passport.authenticate('twitter', {
    scope: 'email'
  }));

  // handle the callback after twitter has authenticated the user
  app.get('/auth/twitter/callback',
    passport.authenticate('twitter', {
      successRedirect: '/profile',
      failureRedirect: '/'
    }));


  // google ---------------------------------

  // send to google to do the authentication
  app.get('/auth/google', passport.authenticate('google', {
    scope: ['profile', 'email']
  }));

  // the callback after google has authenticated the user
  app.get('/auth/google/callback',
    passport.authenticate('google', {
      successRedirect: '/profile',
      failureRedirect: '/'
    }));

  // =============================================================================
  // AUTHORIZE (ALREADY LOGGED IN / CONNECTING OTHER SOCIAL ACCOUNT) =============
  // =============================================================================

  // locally --------------------------------
  app.get('/connect/local', function(req, res) {
    res.render('connect-local.ejs', {
      message: req.flash('loginMessage')
    });
  });
  app.post('/connect/local', passport.authenticate('local-signup', {
    successRedirect: '/profile', // redirect to the secure profile section
    failureRedirect: '/connect/local', // redirect back to the signup page if there is an error
    failureFlash: true // allow flash messages
  }));

  // facebook -------------------------------

  // send to facebook to do the authentication
  app.get('/connect/facebook', passport.authorize('facebook', {
    scope: 'email'
  }));

  // handle the callback after facebook has authorized the user
  app.get('/connect/facebook/callback',
    passport.authorize('facebook', {
      successRedirect: '/profile',
      failureRedirect: '/'
    }));

  // twitter --------------------------------

  // send to twitter to do the authentication
  app.get('/connect/twitter', passport.authorize('twitter', {
    scope: 'email'
  }));

  // handle the callback after twitter has authorized the user
  app.get('/connect/twitter/callback',
    passport.authorize('twitter', {
      successRedirect: '/profile',
      failureRedirect: '/'
    }));


  // google ---------------------------------

  // send to google to do the authentication
  app.get('/connect/google', passport.authorize('google', {
    scope: ['profile', 'email']
  }));

  // the callback after google has authorized the user
  app.get('/connect/google/callback',
    passport.authorize('google', {
      successRedirect: '/profile',
      failureRedirect: '/'
    }));

  // =============================================================================
  // UNLINK ACCOUNTS =============================================================
  // =============================================================================
  // used to unlink accounts. for social accounts, just remove the token
  // for local account, remove email and password
  // user account will stay active in case they want to reconnect in the future

  // local -----------------------------------
  app.get('/unlink/local', isLoggedIn, function(req, res) {
    var user = req.user;
    user.local.email = undefined;
    user.local.password = undefined;
    user.save(function(err) {
      res.redirect('/profile');
    });
  });

  // facebook -------------------------------
  app.get('/unlink/facebook', isLoggedIn, function(req, res) {
    var user = req.user;
    user.facebook.token = undefined;
    user.save(function(err) {
      res.redirect('/profile');
    });
  });

  // twitter --------------------------------
  app.get('/unlink/twitter', isLoggedIn, function(req, res) {
    var user = req.user;
    user.twitter.token = undefined;
    user.save(function(err) {
      res.redirect('/profile');
    });
  });

  // google ---------------------------------
  app.get('/unlink/google', isLoggedIn, function(req, res) {
    var user = req.user;
    user.google.token = undefined;
    user.save(function(err) {
      res.redirect('/profile');
    });
  });


};

// route middleware to ensure user is logged in
function isLoggedIn(req, res, next) {
  if (req.isAuthenticated())
    return next();

  res.redirect('/');
}
